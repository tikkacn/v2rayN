name: release Windows desktop x64 (NoAds)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (empty = auto v<upstreamVersion>)"
        required: false
        type: string
        default: ""
      publish_release:
        description: "Publish to GitHub Release"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  OutputArch: "windows-64"
  OutputPath64: "${{ github.workspace }}/v2rayN/Release/windows-64"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Remove Promotion menu item (menuPromotion) - robust
        shell: bash
        run: |
          set -euo pipefail

          AXAML="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml" | head -n 1 || true)"
          CS="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml.cs" | head -n 1 || true)"

          if [ -z "${AXAML}" ]; then
            echo "MainWindow.axaml not found" >&2
            exit 1
          fi
          if [ -z "${CS}" ]; then
            echo "MainWindow.axaml.cs not found" >&2
            exit 1
          fi

          echo "AXAML=${AXAML}"
          echo "CS=${CS}"

          cat > /tmp/remove_promo.py <<'PY'
import re, sys
from pathlib import Path

axaml_path = Path(sys.argv[1])
cs_path    = Path(sys.argv[2])

x  = axaml_path.read_text(encoding="utf-8", errors="ignore")
c  = cs_path.read_text(encoding="utf-8", errors="ignore")

# 1) remove MenuItem x:Name="menuPromotion" in AXAML
x2 = re.sub(r'(?m)^\s*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*/>\s*\r?\n?', '', x)
if x2 == x:
    x2 = re.sub(r'\s*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*/>\s*', '', x)

if x2 == x:
    raise SystemExit("ERROR: menuPromotion not removed from XAML (pattern not matched).")

if re.search(r'x:Name\s*=\s*"menuPromotion"', x2):
    raise SystemExit("ERROR: menuPromotion still exists in XAML after edit.")

axaml_path.write_text(x2, encoding="utf-8", newline="\n")

# 2) remove any references in code-behind
c2 = re.sub(r'(?m)^\s*.*\bmenuPromotion\b.*\r?\n', '', c)
c2 = re.sub(r'(?ms)^\s*.*\bmenuPromotion\b.*(?:\r?\n\s*.*){0,6}', '', c2)

cs_path.write_text(c2, encoding="utf-8", newline="\n")

final = cs_path.read_text(encoding="utf-8", errors="ignore")
if re.search(r'\bmenuPromotion\b', final):
    raise SystemExit("ERROR: menuPromotion still referenced in MainWindow.axaml.cs after cleanup.")

print("OK: menuPromotion removed from XAML + code-behind")
PY

          python3 /tmp/remove_promo.py "${AXAML}" "${CS}"

      - name: Detect upstream version (for tag/title)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          cd v2rayN

          VER="$(python3 - <<'PY'
import re
from pathlib import Path

candidates = [
  Path("Directory.Build.props"),
  Path("v2rayN.Desktop/v2rayN.Desktop.csproj"),
  Path("ServiceLib/ServiceLib.csproj"),
]

ver = None
for p in candidates:
    if p.exists():
        s = p.read_text(encoding="utf-8", errors="ignore")
        m = re.search(r"<Version>\s*([^<\s]+)\s*</Version>", s)
        if m:
            ver = m.group(1).strip()
            break

if not ver:
    raise SystemExit("Cannot find <Version> in props/csproj")

print(ver)
PY
)"
          echo "version=$VER" >> "$GITHUB_OUTPUT"

          if [ -n "${{ inputs.release_tag }}" ]; then
            echo "tag=${{ inputs.release_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=v${VER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build (publish) x64 into upstream release folder (same style as upstream)
        shell: bash
        run: |
          set -euo pipefail
          cd v2rayN

          rm -rf "${OutputPath64}"
          mkdir -p "${OutputPath64}"

          # v2rayN Desktop
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true -p:EnableWindowsTargeting=true \
            -o "${OutputPath64}"

          # AmazTool (required for upstream-style package contents)
          dotnet publish ./AmazTool/AmazTool.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true -p:EnableWindowsTargeting=true -p:PublishTrimmed=true \
            -o "${OutputPath64}"

      - name: Upload raw publish folder (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-64-noads-raw
          path: ${{ env.OutputPath64 }}

      - name: Package release zip archive (same style as upstream; includes bin/ etc)
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          chmod 755 package-release-zip.sh
          ./package-release-zip.sh "${OutputArch}" "${OutputPath64}"

          # upstream produces: v2rayN-windows-64.zip
          mv "v2rayN-${OutputArch}.zip" "v2rayN-${OutputArch}-NoAds.zip"
          echo "zip=v2rayN-${OutputArch}-NoAds.zip" >> "$GITHUB_OUTPUT"

      - name: Upload packaged zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-64-noads.zip
          path: ${{ steps.pack.outputs.zip }}

      - name: Publish zip to GitHub Release (optional)
        if: inputs.publish_release == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: v2rayN ${{ steps.ver.outputs.version }} 去广告版
          body: |
            - 上游版本：${{ steps.ver.outputs.version }}
            - 构建：Windows x64 / self-contained
            - 打包：上游同款结构（包含 AmazTool、bin 等）
            - 修改：移除菜单推广入口 menuPromotion
          files: |
            ${{ steps.pack.outputs.zip }}
          prerelease: true
          generate_release_notes: false
