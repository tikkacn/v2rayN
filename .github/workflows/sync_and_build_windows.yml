name: sync_and_build_windows (no-promo, x64)

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if no upstream updates"
        required: false
        default: false
        type: boolean
      release_tag:
        description: "If set, upload zip to GitHub Release with this tag (e.g. v7.18.0)"
        required: false
        default: ""
        type: string
  schedule:
    - cron: "0 */6 * * *" # every 6 hours (UTC)

permissions:
  contents: write

concurrency:
  group: sync-and-build-windows
  cancel-in-progress: true

env:
  OUTPUT_ARCH: "windows-64"
  OUTPUT_PATH64: "${{ github.workspace }}/v2rayN/Release/windows-64"

jobs:
  sync_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Configure git
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add & fetch upstream (2dust/v2rayN)
        shell: bash
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/2dust/v2rayN.git 2>/dev/null || true
          git fetch upstream --prune
          git remote set-head upstream -a

      - name: Detect upstream default branch & changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          upRef="$(git symbolic-ref -q refs/remotes/upstream/HEAD || true)"
          if [ -z "$upRef" ]; then
            echo "Cannot resolve upstream HEAD" >&2
            exit 1
          fi
          up="${upRef#refs/remotes/}"   # e.g. upstream/master or upstream/main
          behind="$(git rev-list --count "HEAD..$up")"
          echo "up=$up" >> "$GITHUB_OUTPUT"
          echo "behind=$behind" >> "$GITHUB_OUTPUT"
          echo "Upstream branch: $up"
          echo "Upstream ahead by $behind commits"

      - name: Exit if no upstream updates (unless forced)
        if: steps.diff.outputs.behind == '0' && inputs.force_build != true
        shell: bash
        run: |
          set -euo pipefail
          echo "No upstream updates. Exit."
          exit 0

      - name: Merge upstream & push (only if changed)
        if: steps.diff.outputs.behind != '0'
        shell: bash
        run: |
          set -euo pipefail
          git merge --no-edit "${{ steps.diff.outputs.up }}"
          git push origin HEAD

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -------- remove Promotion (menuPromotion) robustly: XAML + code-behind --------
      - name: Remove Promotion menu item (menuPromotion) from MainWindow.axaml + code-behind
        shell: bash
        run: |
          set -euo pipefail

          AXAML="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml" | head -n 1 || true)"
          CS="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml.cs" | head -n 1 || true)"

          if [ -z "$AXAML" ]; then
            echo "MainWindow.axaml not found" >&2
            exit 1
          fi
          if [ -z "$CS" ]; then
            echo "MainWindow.axaml.cs not found" >&2
            exit 1
          fi

          echo "AXAML=$AXAML"
          echo "CS=$CS"

          python3 - <<'PY'
import re, pathlib, sys

axaml_path = pathlib.Path(sys.argv[1])
cs_path    = pathlib.Path(sys.argv[2])

# ---------- XAML cleanup ----------
x = axaml_path.read_text(encoding="utf-8", errors="ignore")

# Remove a self-closing MenuItem with x:Name="menuPromotion"
pat1 = re.compile(r'(?m)^[ \t]*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*/>[ \t]*\r?\n?')
x2 = pat1.sub("", x)

# Remove non-self-closing MenuItem (defensive)
pat2 = re.compile(r'(?ms)^[ \t]*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*>.*?</MenuItem>[ \t]*\r?\n?')
x2 = pat2.sub("", x2)

# Final guard for XAML: must not contain menuPromotion
if re.search(r'\bx:Name\s*=\s*"menuPromotion"\b', x2):
    raise SystemExit("ERROR: menuPromotion still exists in MainWindow.axaml after cleanup")

if x2 == x:
    # If upstream changed the exact markup and we failed to match, we fail loudly
    raise SystemExit("ERROR: XAML pattern not matched; menuPromotion not removed (upstream markup changed)")

axaml_path.write_text(x2, encoding="utf-8", newline="\n")
print("OK: menuPromotion removed from XAML")

# ---------- code-behind cleanup ----------
c = cs_path.read_text(encoding="utf-8", errors="ignore")

# Remove any lines referencing menuPromotion (event hookups, etc.)
c2 = re.sub(r'(?m)^[ \t]*.*\bmenuPromotion\b.*\r?\n', "", c)

# Remove MenuPromotion_Click method if present (common pattern)
# Covers: private/ public/ protected/ internal, async optional, return void/Task
c2 = re.sub(
    r'(?ms)^[ \t]*(?:private|public|protected|internal)?[ \t]*(?:async[ \t]+)?(?:void|Task)[ \t]+MenuPromotion_Click\s*\([^)]*\)\s*\{.*?\}\s*\r?\n?',
    "",
    c2
)

cs_path.write_text(c2, encoding="utf-8", newline="\n")

final = cs_path.read_text(encoding="utf-8", errors="ignore")
if re.search(r'\bmenuPromotion\b', final):
    raise SystemExit("ERROR: menuPromotion still referenced in MainWindow.axaml.cs after cleanup")

print("OK: code-behind cleaned")
PY "$AXAML" "$CS"

      - name: Build (publish) win-x64 into upstream release folder layout
        shell: bash
        run: |
          set -euo pipefail
          cd v2rayN

          rm -rf "./Release/windows-64" || true
          mkdir -p "./Release/windows-64"

          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true -p:EnableWindowsTargeting=true \
            -o "${OUTPUT_PATH64}"

          dotnet publish ./AmazTool/AmazTool.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true -p:EnableWindowsTargeting=true -p:PublishTrimmed=true \
            -o "${OUTPUT_PATH64}"

      - name: Upload raw publish folder (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-64-raw
          path: |
            ${{ github.workspace }}/v2rayN/Release/windows-64

      # -------- package like upstream: generate zip with bin folder, etc. --------
      - name: Package release zip archive (same style as upstream) + add "no-promo" suffix
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ github.workspace }}"

          chmod 755 package-release-zip.sh
          ./package-release-zip.sh "${OUTPUT_ARCH}" "${OUTPUT_PATH64}"

          # upstream creates: v2rayN-windows-64.zip
          # rename to: v2rayN-windows-64-no-promo.zip
          if [ -f "v2rayN-${OUTPUT_ARCH}.zip" ]; then
            mv "v2rayN-${OUTPUT_ARCH}.zip" "v2rayN-${OUTPUT_ARCH}-no-promo.zip"
          else
            echo "ERROR: expected zip not found: v2rayN-${OUTPUT_ARCH}.zip" >&2
            ls -la
            exit 1
          fi

      - name: Upload packaged zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-64-no-promo.zip
          path: |
            ${{ github.workspace }}/v2rayN-windows-64-no-promo.zip

      - name: Upload zip to GitHub Release (optional)
        if: inputs.release_tag != ''
        uses: svenstaro/upload-release-action@v2
        with:
          file: ${{ github.workspace }}/v2rayN-windows-64-no-promo.zip
          tag: ${{ inputs.release_tag }}
          overwrite: true
          prerelease: true
          release_name: "${{ inputs.release_tag }} 去广告版"
