name: sync_and_build_windows_x64_nopromo

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if no upstream updates"
        required: false
        type: boolean
        default: false
      release_tag:
        description: "If set, upload zip to GitHub Release with this tag (e.g. v7.18.0)"
        required: false
        type: string
        default: ""
  schedule:
    - cron: "0 */6 * * *" # 每 6 小时检查一次（UTC）

permissions:
  contents: write

concurrency:
  group: sync-and-build-windows-x64-nopromo
  cancel-in-progress: true

env:
  OutputArch: "windows-64"
  OutputPath64: "${{ github.workspace }}/v2rayN/Release/windows-64"

jobs:
  sync_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add & fetch upstream (2dust/v2rayN)
        shell: bash
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/2dust/v2rayN.git 2>/dev/null || true
          git fetch upstream --prune
          # 解析 upstream 默认分支
          UP_BRANCH="$(git remote show upstream | awk -F': ' '/HEAD branch/ {print $2}')"
          if [ -z "${UP_BRANCH}" ]; then
            echo "Cannot resolve upstream default branch"
            exit 1
          fi
          echo "up_branch=${UP_BRANCH}" >> "$GITHUB_OUTPUT"
        id: up

      - name: Detect upstream changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          UP_BRANCH="${{ steps.up.outputs.up_branch }}"
          UP_REF="upstream/${UP_BRANCH}"
          BEHIND="$(git rev-list --count "HEAD..${UP_REF}")"
          echo "behind=${BEHIND}" >> "$GITHUB_OUTPUT"
          echo "up_ref=${UP_REF}" >> "$GITHUB_OUTPUT"
          echo "Upstream ahead by ${BEHIND} commits (${UP_REF})"

      - name: Exit if no upstream updates (unless forced)
        if: steps.diff.outputs.behind == '0' && inputs.force_build != true
        shell: bash
        run: |
          echo "No upstream updates. Exit."
          exit 0

      - name: Merge upstream & push (only if changed)
        if: steps.diff.outputs.behind != '0'
        shell: bash
        run: |
          set -euo pipefail
          git merge --no-edit "${{ steps.diff.outputs.up_ref }}"
          git push origin HEAD

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Remove Promotion menu item (AXAML) + Fix code-behind references (robust)
        shell: bash
        run: |
          set -euo pipefail

          # 1) 定位 MainWindow.axaml
          AXAML="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml" | head -n 1 || true)"
          if [ -z "${AXAML}" ]; then
            echo "MainWindow.axaml not found"
            exit 1
          fi

          # 2) 定位 MainWindow.axaml.cs
          CS="$(find . -type f -path "*/v2rayN.Desktop/Views/MainWindow.axaml.cs" | head -n 1 || true)"
          if [ -z "${CS}" ]; then
            echo "MainWindow.axaml.cs not found"
            exit 1
          fi

          echo "AXAML=${AXAML}"
          echo "CS=${CS}"

          # ----------------------------
          # A) 删除 AXAML 里 menuPromotion 这个 MenuItem（整行/整段都兜底）
          # ----------------------------
          perl -0777 -i -pe '
            # 删除自闭合写法：<MenuItem ... x:Name="menuPromotion" .../>
            s{(?m)^\s*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*/>\s*\R?}{}g;

            # 删除成对标签写法：<MenuItem ... x:Name="menuPromotion" ...> ... </MenuItem>
            s{(?ms)^\s*<MenuItem\b[^>]*\bx:Name\s*=\s*"menuPromotion"[^>]*>.*?</MenuItem>\s*\R?}{}g;
          ' "${AXAML}"

          if grep -qE 'x:Name\s*=\s*"menuPromotion"' "${AXAML}"; then
            echo "ERROR: menuPromotion still exists in AXAML after edit."
            exit 1
          fi
          echo "✅ menuPromotion removed from AXAML"

          # ----------------------------
          # B) 删除 code-behind 里对 menuPromotion 的引用（避免 CS0103）
          # 常见形态：menuPromotion.Click += MenuPromotion_Click;
          # 或 MenuPromotion_Click 方法、任何包含 menuPromotion 的行
          # ----------------------------
          perl -0777 -i -pe '
            # 1) 直接删除任何包含 menuPromotion 的整行
            s{(?m)^\s*.*\bmenuPromotion\b.*\R}{}g;

            # 2) 删除 MenuPromotion_Click 方法（如果有）
            s{(?ms)^\s*(?:private|public|protected|internal)?\s*(?:async\s+)?void\s+MenuPromotion_Click\s*\([^)]*\)\s*\{.*?\}\s*}{}g;
          ' "${CS}"

          if grep -qE '\bmenuPromotion\b' "${CS}"; then
            echo "ERROR: menuPromotion still referenced in MainWindow.axaml.cs after cleanup."
            exit 1
          fi
          echo "✅ code-behind cleaned"

      - name: Detect upstream version (for release title)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          # 尽量从 Directory.Build.props / csproj 里找 <Version>
          CANDIDATES=(
            "v2rayN/Directory.Build.props"
            "v2rayN/v2rayN.Desktop/v2rayN.Desktop.csproj"
            "v2rayN/ServiceLib/ServiceLib.csproj"
          )
          VER=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              VER="$(python3 - <<'PY'
import re, sys, pathlib
p = pathlib.Path(sys.argv[1])
s = p.read_text(encoding="utf-8", errors="ignore")
m = re.search(r"<Version>\s*([^<\s]+)\s*</Version>", s)
print(m.group(1).strip() if m else "")
PY
"$p")"
              if [ -n "$VER" ]; then break; fi
            fi
          done
          if [ -z "$VER" ]; then
            echo "WARN: cannot find <Version>, fallback to unknown"
            VER="unknown"
          fi
          echo "ver=$VER" >> "$GITHUB_OUTPUT"
          echo "release_name=v${VER} 去广告版" >> "$GITHUB_OUTPUT"

      - name: Build (publish) x64 into upstream release folder (with AmazTool)
        shell: bash
        run: |
          set -euo pipefail
          cd v2rayN

          rm -rf "${OutputPath64}"
          mkdir -p "${OutputPath64}"

          # v2rayN Desktop (win-x64)
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj \
            -c Release \
            -r win-x64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -o "${OutputPath64}"

          # AmazTool (win-x64) - trimmed like upstream
          dotnet publish ./AmazTool/AmazTool.csproj \
            -c Release \
            -r win-x64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -p:PublishTrimmed=true \
            -o "${OutputPath64}"

      - name: Upload raw publish folder (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: raw-publish-windows-64
          path: ${{ env.OutputPath64 }}

      - name: Package release zip archive (same style as upstream)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x package-release-zip.sh
          ./package-release-zip.sh "${OutputArch}" "${OutputPath64}"
          # 生成的默认名字：v2rayN-windows-64.zip
          # 我们改名带去广告标识（文件名尽量用英文，避免某些系统解压乱码）
          if [ -f "v2rayN-${OutputArch}.zip" ]; then
            mv "v2rayN-${OutputArch}.zip" "v2rayN-${OutputArch}-nopromo.zip"
          fi

      - name: Upload packaged zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-64-nopromo.zip
          path: v2rayN-${{ env.OutputArch }}-nopromo.zip

      - name: Upload zip to GitHub Release (optional)
        if: inputs.release_tag != ''
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ inputs.release_tag }}
          release_name: ${{ steps.ver.outputs.release_name }}
          file: v2rayN-${{ env.OutputArch }}-nopromo.zip
          asset_name: v2rayN-${{ env.OutputArch }}-nopromo.zip
          overwrite: true
          prerelease: false
