name: Windows Desktop (No-Promo)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g. v7.18.0-nopromo)"
        required: false
        type: string
  push:
    branches:
      - master

env:
  OutputArch: "windows-64"
  OutputArchArm: "windows-arm64"
  OutputPath64: "${{ github.workspace }}/v2rayN/Release/windows-64"
  OutputPathArm64: "${{ github.workspace }}/v2rayN/Release/windows-arm64"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Add upstream (2dust/v2rayN)
        run: |
          git remote add upstream https://github.com/2dust/v2rayN.git || true
          git fetch upstream

      - name: Merge upstream
        run: |
          git merge upstream/master --no-edit || true
          git push origin HEAD || true

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build v2rayN Desktop
        run: |
          cd v2rayN
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -o $OutputPath64

          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj \
            -c Release -r win-arm64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -o $OutputPathArm64

      - name: Build AmazTool
        run: |
          cd v2rayN
          dotnet publish ./AmazTool/AmazTool.csproj \
            -c Release -r win-x64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -p:PublishTrimmed=true \
            -o $OutputPath64

          dotnet publish ./AmazTool/AmazTool.csproj \
            -c Release -r win-arm64 \
            -p:SelfContained=true \
            -p:EnableWindowsTargeting=true \
            -p:PublishTrimmed=true \
            -o $OutputPathArm64

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: v2rayN-windows-desktop-nopromo
          path: v2rayN/Release/windows*

      - name: Package release zip
        if: github.event.inputs.release_tag != ''
        run: |
          chmod +x package-release-zip.sh
          ./package-release-zip.sh $OutputArch $OutputPath64
          mv v2rayN-${OutputArch}.zip v2rayN-${OutputArch}-desktop-nopromo.zip
          ./package-release-zip.sh $OutputArchArm $OutputPathArm64
          mv v2rayN-${OutputArchArm}.zip v2rayN-${OutputArchArm}-desktop-nopromo.zip

      - name: Upload release zip
        if: github.event.inputs.release_tag != ''
        uses: svenstaro/upload-release-action@v2
        with:
          file: v2rayN-*-desktop-nopromo.zip
          tag: ${{ github.event.inputs.release_tag }}
          file_glob: true
          prerelease: false
